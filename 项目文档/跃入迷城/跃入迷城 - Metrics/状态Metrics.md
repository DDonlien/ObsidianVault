
**状态Metrics**

1. 所有的状态统计在这里：[物品列表](https://dikpa4hrtn9.feishu.cn/wiki/IbdswSAf1iFX9Ik5LRDcg02LnTb?from=from_copylink)
2. 状态**来源**有3类，可以多选：属性异常、装备、环境
1. 属性异常：由异常积蓄（动能、热能、）或特定属性攻击直接触发
2. 其他：由武器或义体触发（包括智脑和行为芯片）
3. 环境：由环境效果、道具触发
3. 状态的**效果结算**有3种叠加情况：
- 线性叠加：当有多层同类Buff存在时，同类Buff的同字段效果数值直接相加结算
- 分别计算：当有多层同类Buff存在时，同类Buff的同字段效果单独结算N次
- 取最高值：当有多层同类Buff存在时，同类Buff的同字段效果取其最高值结算
4. 所有的技能都有叠加层数上限，但有时为1，该上限可能被其他效果修改
5. 互相冲突的状态（例如加速的Buff和减速的Debuff）总是会最终作用到具体的角色属性（GE/GA），目前一律让代码自行默认状态处理，发现Bug后
6. 状态的**持续时间**有4种叠加情况：
- 单独结算：单独结算每一层效果的持续时间。
- 重置时间：每次施加新效果时，用新效果的持续时间重置同一效果的持续时间，无论是否更久。
- 叠加时间：每次施加新效果时，用新效果的持续时间加总到现有效果的剩余持续时间上。
- 无法叠加：如果已有同一效果存在，则新效果无法附加。
7. 状态**触发伤害时的数值**，有5种计算来源：
1. 非触发式持续伤害，由武器攻击/武器技能**附加状态**，基于附加的武器的**异常积蓄**值计算
2. 触发式非伤害关联性伤害，由武器攻击/武器技能**触发计算**，基于触发计算的武器的**武器伤害**值计算
3. 非触发式持续伤害，由义体/智脑**附加状态**，基于角色**特定属性**值计算
4. 触发式非伤害关联性伤害，由义体/智脑**触发计算**，基于角色**特定属性**值计算
5. 伤害关联性伤害，由触发的伤害值计算
6. 上述a～d**异常积蓄**和**武器伤害**采用性能矫正前的数值，则采用性能矫正后的数值，详见[武器Metrics](武器Metrics.md)，f则如上述，采用实际发生的伤害值计算
8. 对于“造成额外伤害”类的状态，需要标识该额外伤害是否被**“分开结算伤害”**
1. 如果是：当原本造成伤害100，造成额外伤害20%，则会受到**1次100点**和**1次20点**伤害
2. 如果否：当原本造成伤害100，造成额外伤害20%，则会受到**1次120点**伤害
3. 该设计影响暴击结算，前者计算2次，后者计算1次
9. 暴击的计算@Decay@兔只几何二位看下是否合理
1. 暴击的判定及伤害加成计算发生在伤害结算流程的最后阶段
2. 暴击是否发生及其效果强度，由攻击方和受伤方身上多种可叠加的状态效果（Buffs/GEs?）共同决定。这些效果可以被标记为隐藏或可见：
- A: AttackerCritChanceModifier (攻击者暴击率修正)
- B: TargetCritVulnerability (目标暴击易伤率 / 受暴击率修正)
- C: AttackerCritDamageModifier (攻击者暴击伤害修正)
- D: TargetCritDamageTakenModifier (目标受暴击伤害修正)
3. 上述4个Buff均可以线性叠加，也可以被不同的技能或效果附加，例如一个角色可以同时有2个“暴击率增加15%”的效果，此时它被视作拥有A1、A2
4. 暴击的计算为每次基础伤害计算时计算一次，详见“3”
5. 暴击的计算规则如下
- 计算最终暴击率： FinalCritChance=Clamp(BaseCritChance+∑An+∑Bn,0,100) 
- 其中 BaseCritChance 为基础暴击率，在没有任何Buff的情况下为0%，仅作为计算冗余，可以移除
- Clamp函数确保结果在0%到100%之间
- 判定： IsCrit=(Random(0,100)<FinalCritChance) 
- 生成一个0到100的随机数，如果小于最终暴击率则视为暴击
6. 暴击伤害的计算规则如下
- 计算最终伤害：FinalDamage=BaseDamage×(1+BaseCritDamageBonus%+∑Cn+∑Dn) 
- 其中，BaseCritDamageBonus% 固定为 100% （代表默认的额外100%伤害）
7. 为了便于讲述，所有可能附加暴击的技能，不单独描述为“施加一层xxx效果的暴击buff”，但技能开发详述里会写明，以便明确实装
8. 暴击类的Buff可能会被本应结算暴击的行动附加，取最复杂的情况为例：
1. “你的下一次攻击如果造成暴击，则造成额外的暴击伤害，增幅比例取决于你和该敌人的距离”
2. 此时显然“我和该敌人的距离”需要等Projectile击中才能被正确结算，因此需要对被击打对象附加一个**D**，而非提前对自己附加**C**来实现（这里使用outgoingspec应该可以？）
3. 此时，暴击和暴击伤害的结算，应当晚于此效果的施加，以确保正确结算效果
4. 对于其他更简单的，例如“被你攻击的敌人，3秒内有20%概率受到暴击”，同样应该晚于效果的附加结算暴击/暴击伤害
9. 对于“某次攻击期间生效的暴击或暴击伤害效果”，有2种可能的计算方法
1. 精准计算：制作一个只持续1次结算（而非特定时长）的暴击/暴击伤害Buff
2. 粗略计算：施加一个持续极短时间短暴击/暴击伤害Buff，这可能导致一些预期外的暴击效果
3. 如果工程实现没有问题，强烈建议使用精准计算@Decay



