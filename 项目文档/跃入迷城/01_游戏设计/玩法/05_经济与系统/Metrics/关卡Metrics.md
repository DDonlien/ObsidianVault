
**关卡Metrics**

**关卡切换**

1. 游戏中存在如下名词：

**主题关卡（Theme Level）**

- 指一个Boss所属的阵营相关的所有关卡，同一个主题关卡有一套固定的美术风格、敌人配置、环境交互机制
- 由于肉鸽的特性，即使在同一个版本中，一个主题关卡的关卡数量是不固定的，例如“劳旅”的主题关卡覆盖Level 1~10或1~8或1~12，取决于每个Loop的进度和情况，但不会有太大范围的浮动

**主题扇区（Theme Section）**

- 指一个主题关卡在完整的大楼平面图中，允许出现的扇区

**区域（Section）**

- 指一个扇区中，将会被拆分为一张地图的世界坐标空间，一个扇区由多个区域组成

**关卡（Level）**

- 游戏中最常见的关卡概念，随着关卡越靠后（在我们的游戏中，靠上），挑战难度越高
- 根据[v0.0.5](../跃入迷城 - 子版本规划/v0.0.5.md)的设计，每个关卡会加载整个主题扇区中的多个、但未必是全部区域

**地图（Map）**

- 每个区域可以承载大致上范围近似的无数个地图变种，MAP对应到游戏中实际的地图蓝图资产

**区域传送门 (Section Gate)**

- 定义了地图之间（通常是跨区域）的连接关系，作为BP包含在每个**地图**内
- 包含 to section No 属性，指明目标区域
- 包含 is Enabled Enter 状态，决定是否允许从目标区域通过此门进入当前地图所在区域
- 包含 is Enabled Leave 状态，决定是否允许从当前地图通过此门离开前往目标区域

**电梯朝向 (Elevator Orientation)**

- 指地图出入口电梯门的朝向。这是关卡切换时的一个重要匹配条件，以确保演出连贯性
2. 玩家完成当前关卡（假设：位于MAP A）并与终点电梯交互后，触发关卡切换流程：

**交互与演出:**

- 玩家与终点电梯交互。
- 播放过场演出：
- 玩家角色强制走进电梯。
- 电梯门关闭。
- 玩家角色转身面向电梯门。
- 屏幕上下添加黑边，变为 21:9 比例。
- （待定）电梯门关闭后，外部景象 Fadeout 至全黑。
- 电梯轻微抖动，播放相关音效。

**后台加载:** 系统根据匹配逻辑（详见下一节）查找并加载下一关卡的地图（MAP B）及相关区域。

**切换完成:**

- 下一关卡加载完毕。
- 恢复玩家控制权。
- 玩家需要手动操作打开电梯门，进入新的地图 B。
3. 当玩家从地图 A 乘坐电梯前往下一关时，系统执行以下匹配逻辑：

**核心匹配条件:**

- **关卡等级 (LvCnt):** 候选地图 B 的 LvCnt 属性必须与**下一关卡等级**兼容。
- **电梯朝向:** 候选地图 B 的**起点电梯朝向**必须与当前地图 A 的**终点电梯朝向**一致。
- 然后系统应该根据Map B的Sec Gate定义，选择需要选定地图的下一个Section，此时无需考虑电梯朝向，但被加载的MAP指向来源Sec的Sec Gate必须is Enabled Enter
- Section Gate会定义“to section No”，所以很容易知道这个信息
- 如果一个MAP有多个Section Gate处于is Enable Leave状态，则按照顺序匹配完全部Enable的Section，然后再去下一个Section进行地图匹配
- 例如：MAP A在Sec 1，其2个启用的Sec Gate可以前往Sec 2、3，此时地图的随机生成顺序应该是：
- Sec 2 -> Sec 3 -> Sec 2Next -> Sec 3Next
- 这里的基本逻辑是优先填充每一层的内容，以确保玩家不会很快遇到无法前往的下一个Section
- 这里没有引入随机，是为了减少开发成本，如果玩家很容易读到我们的逻辑并且影响了体验，再说
- 具体匹配过程中，可能遇到的情况如下：

|![...](../跃入迷城%20-%20Metrics/images/关卡Metrics.001.png)|![...](../跃入迷城%20-%20Metrics/images/关卡Metrics.001.png)|![...](../跃入迷城%20-%20Metrics/images/关卡Metrics.001.png)|
| :-: | :-: | :-: |
- 当出现LvCnt、Section Gate的限制导致某个Sec无法获取到可用MAP的情况时，跳过

**地图布置**

1. 每个关卡的最小布置单位是50cm，在Figma里是50像素，下文不赘述单位
2. 玩家视野范围约为1000~1400半径，取决于是否使用远程武器瞄准
3. 关卡最大~~面积不超过5000 x 5000~~包络区域周长不大于20000，由外围边界界定
4. 关卡的最小面积不小于4000000cm^2，在figma中选中关卡绘图后，实际的关卡矩形会计算该面积
5. 关卡和关卡之间不能重叠，但可以（并且建议）紧邻
6. 玩家需要有一条方向清晰的动线，从关卡的起点，移动到终点
7. 每个关卡都应该包含至少1个分岔路
8. 当路径分叉，玩家应该可以再至多额外经过1个房间后会和
9. 分岔路可以再包含分岔路，则从分叉点重新开始计算规则9
10. 关卡中的死胡同/死路房间数量，应该不多于"ROUNDUP (关卡总房间数量 - 6) / 2"
11. Section Gate做为出口，需要在关卡终点的同一个房间，并且在1000视野内可见
12. 墙面只能存在横平竖直，或45°倾斜的情况
13. 2个连续的斜45°不应该相连
1. 在135°的外角面，一个40x40x300的证八边形可以很好的完成衔接墙面的任务
14. 斜45°的墙面应该使用SQRT(2, 3, 4, 5, 6)长度的墙面或门洞墙面，不进行任何组合拼接
15. 墙壁的厚度是轴对称的40，也就是半面墙厚度为20。一般情况下，游戏中不会出现只有半面墙的场景，但大部分情况下会出现两个房间各自拥有半面墙，背靠背组合成完整的墙壁
16. 墙壁的最小宽度是100，我们分别有100、200、300、400四种尺寸的墙壁来组合所有墙壁
1. 另外FYI，高度固定是300
17. 走廊也应该被视作一个异形房间
18. 每个房间应该拥有不超过**8**个边
19. 不应该出现小于90°的夹角在房间内
20. 奖励房间应该在玩家必经之路上，或就是必经之路的一部分
21. 由于墙壁的特征，超过180°的墙面夹角会产生缝隙穿帮，在我们的游戏中只有2种情况
1. 225°，用一个60x60的八边形柱体的1/4可以很好的遮挡
2. 270°，用一个50x50的四边形柱体的3/4可以很好的遮挡
3. 穿帮的场景如下图，可以看到，外墙面存在一个明显的缺口

![...](../跃入迷城%20-%20Metrics/images/关卡Metrics.002.png)

22. 门和门如果彼此安置在2面平行的墙面上，且距离小于2个门的BP宽度，则不应该直接对应，需要至少错开1个门的身位，1个门的宽度取决于2个面对面的门之间较小的BP宽度
23. 门和门如果彼此相邻，应当至少间隔1/2的蓝图宽度
1. 蓝图宽度指门的BP的宽度，例如下图，门的BP宽度为200，则间隔至少为100
2. 使用“蓝图宽度”是因为门的蓝图还包含了一部分墙面，用于规整尺寸、左右衔接，不仅仅是门洞本身的尺寸

![...](../跃入迷城%20-%20Metrics/images/关卡Metrics.003.png)

24. 同一个关卡的Ending应该至少有2个，至多有4个出口选项，且其中电梯或Section Gate不超过2个
25. 关卡里可以出现无法通行、作为点缀的电梯和Section Gate，一来提高沉浸感，二来锚定Section内部的相对空间感
26. 如果废弃的Section Gate and/or 电梯门出现，其背后的对应结构（Section连接走廊、阳台栈板，or 电梯）也必须出现，以确保空间的沉浸感
27. 同一个Section的不同Start/End，如果在近似位置出现，则应该在完全一样的位置出现，也即同一个Section不应该在右下角同样朝向左侧的电梯里有2个不同的位置配置，以确保后续会转移到PCG时可以简单处理该问题，并养成玩家的探索习惯
28. 同一个Section的一张地图应该有不少于6个，不多于10个房间构成
29. 地图和地图之间如果有墙面紧密贴合，贴合的连续墙面应该包含不超过2次角度变化，否则应该截断

**区域门**

1. 玩家在关卡结束后，可以通过终点电梯前往下一个楼层（更高难度）或通过区域门前往当前楼层的其他区域
2. 区域门具有“Exit”和“Enter”两种核心属性。
3. **Exit门**的功能是：允许玩家从此门离开当前所在的游戏区域。
4. Exit区域门必须与当前区域的“区域终止电梯”设置在同一个房间内。
5. **Enter门**的功能是：允许玩家从此门进入新的目标游戏区域。
6. Enter区域门必须与目标区域的“区域起始电梯”设置在同一个房间内。
7. 每个Exit门都必须与一个Enter门成组相连。
8. 这两个门之间的连接空间必须为玩家提供清晰且简洁的移动路径。
1. 清晰且简洁：不超过2个90度转角。
9. 游戏流程规定：一旦玩家通过Exit门进入其后的连接空间，该Exit门便会关闭。此后玩家只能单向朝对应的Enter门前进，无法折返。
10. 地图设计层面：成对的区域门及其连接通道，在结构上必须支持双向通行。
1. 双向通行：存在满足条件的地图，使玩家可以从区域门A前往B，也可以从B前往A。
2. 如果上述条件无法满足，需要通过增设区域门实现双向联通：玩家可以从区域门A前往B、从B前往C，而A和C同时在区域1的同一个房间。
11. 此连接通道在视觉和空间上应保持独立，不与任何主要游戏区域的活动空间发生干涉，并维持其结构和视觉上的简洁性。

[**路由密钥**](https://dikpa4hrtn9.feishu.cn/wiki/VRQGwzqjYic5kykNm0Dc7YkYnge?from=from_copylink)

1. 消耗1个密钥，刷新电梯后下一楼层第一个关卡的奖励
2. 消耗1个密钥，开启当前楼层其他区域的区域门
3. 局外升级
1. 密钥的携带上限取决于记忆栈等级
2. 密钥可以通过局外升级，提升预设的带入每局挑战的数量
3. 密钥可以通过局外升级，提升刷新/解锁访问到的区域的装备有度
4. 密钥可以通过局外升级与设置，修改刷新到的区域的奖励倾向性
5. 密钥可以通过局外升级，增加局内的恢复手段
4. 局内恢复
1. 密钥可以通过击杀BOSS和某些特殊的精英怪，在局内恢复
2. 密钥可以在商店楼层消耗信用点（大量）购买

**Figma绘制规则**

1. 各类特征的图例，见Figma
2. 需要在Figma中绘制
3. 所有墙面，使用Pen工具，绘制封闭多边形，调整为Inside Line

![...](../跃入迷城%20-%20Metrics/images/关卡Metrics.004.png)

4. 针对栏杆的外墙，无需处理singleside，直接画线段做成厚度合适的double side即可，栏杆的对称厚度为20
5. 针对非栏杆的外墙，无需绘制另外一半的厚度
6. Figma绘制同时有栏杆和墙面的房间时，会产生如下图一样的错位，无需处理，节省时间

![...](../跃入迷城%20-%20Metrics/images/关卡Metrics.005.png)

7. 窗在游戏中使用边缘+循环部分组合，实现任意尺寸，因此在Figma中也这样绘制

![...](../跃入迷城%20-%20Metrics/images/关卡Metrics.006.png)

**关卡组件**

**预设关卡**

**PCG**

1. 检查没有贴住墙面的墙面，视作外墙，自动附加对应类型的墙面
2. 由于阳台栏杆一定会是外墙，因此不遵守上述规则1，其本身就是double厚度的墙面


